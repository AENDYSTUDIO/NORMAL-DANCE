# NormalDance Coding Standards v2.0

> –î–æ–∫—É–º–µ–Ω—Ç —Ç–æ—á–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∫–∞–∫ of 2025-06-25

---

## 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### 1.1 ESLint

- **–°—Ç–∞—Ç—É—Å:** –æ—Ç–∫–ª—é—á—ë–Ω (legacy-—Ñ–∞–π–ª `.eslintrc.json` –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è CI, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)
- **–ü—Ä–∏—á–∏–Ω–∞:** –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **TypeScript + Prettier** + **Husky pre-commit** –¥–ª—è –ª–∏–Ω—Ç–∏–Ω–≥–∞
- **–ü—Ä–∞–≤–∏–ª–æ:** **–ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å eslint-–ø—Ä–∞–≤–∏–ª–∞ –≤ CI** ‚Äì **–ª–æ–≥–∏–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —á–µ—Ä–µ–∑ `tsc --noEmit`**

### 1.2 TypeScript

- **–ö–æ–Ω—Ñ–∏–≥:** `tsconfig.json` (strict: false, noImplicitAny: false)
- **–†–∞–∑—Ä–µ—à–µ–Ω–æ:** `any` –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö `src/lib/legacy/` –∏ `src/types/temp/`
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** —è–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è **–ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π** –∏ **smart-contract –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤**

### 1.3 Prettier

- **–ö–æ–Ω—Ñ–∏–≥:** `.prettierrc.json` (singleQuote: true, trailingComma: all)
- **–•—É–∫:** `husky pre-commit` ‚Üí `pretty-quick --staged`

### 1.4 Environment

- **–§–æ—Ä–º–∞—Ç:** `.env.local` (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è)
- **–ü—Ä–µ—Ñ–∏–∫—Å NEXT*PUBLIC*** —Ç–æ–ª—å–∫–æ –¥–ª—è **–ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç** (program-id, mint, rpc-endpoint –±–µ–∑ –∫–ª—é—á–∞)
- **–°–µ–∫—Ä–µ—Ç—ã** (–∫–ª—é—á–∏, —Å–∏–¥-—Ñ—Ä–∞–∑—ã) ‚Äì **–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞**, **—á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–º**

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 2.1 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- **–ü—Ä–æ–¥:** SQLite + Prisma (—Ñ–∞–π–ª `prisma/dev.db` –≤ `.gitignore`)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** `npx prisma migrate dev`
- **–°–∏–¥-–¥–∞–Ω–Ω—ã–µ:** `prisma/seed.ts` (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ `npm run dev`)

### 2.2 –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

- **–§–∞–π–ª:** `server.ts` (Express + Socket.IO)
- **–ü–æ—Ä—Ç—ã:**
  - 3000 ‚Üí Next.js
  - 3001 ‚Üí Socket.IO (REST + WS)
- **–ü—Ä–∞–≤–∏–ª–æ:** **–≤—Å–µ WebSocket-—Ä—É—Ç—ã** –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `/socketio/**`
- **CORS:** —Å—Ç—Ä–æ–≥–æ `NEXT_PUBLIC_SITE_URL` –∏–∑ env

### 2.3 –î–≤–æ–π–Ω–∞—è —Å—Ä–µ–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- **Jest:** unit-—Ç–µ—Å—Ç—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É—Ç–∏–ª–∏—Ç (–ø–∞–ø–∫–∞ `__tests__`)
- **Playwright:** e2e, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω–æ** –æ—Ç –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Mock:**
  - `src/lib/__mocks__/web3.ts` ‚Üí –º–æ–∫-–∞–Ω—Å–∞–º–±–ª—å –¥–ª—è Phantom
  - `src/lib/__mocks__/ton-wallet.ts` ‚Üí TON Connect mock

---

## 3. Web3 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞

### 3.1 Phantom Wallet

- **–ü–∞—Ç—Ç–µ—Ä–Ω:** –∫–∞—Å—Ç–æ–º–Ω—ã–π Event-Emitter ‚Üí `src/lib/phantom-events.ts`
- **–ó–∞–ø—Ä–µ—Ç:** `window.solana` –Ω–∞–ø—Ä—è–º—É—é ‚Äì **–≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ `getPhantomProvider()`**
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
  ```ts
  if (!resp.publicKey) throw new PhantomUserRejectedError();
  ```

### 3.2 TON Connect

- **–ê–¥–∞–ø—Ç–µ—Ä:** `@tonconnect/ui-react` ‚Üí **–æ–±—ë—Ä—Ç–∫–∞ `TonConnectButton.tsx`**
- **–ü—Ä–∞–≤–∏–ª–æ:** **–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `wallet.account.chain`** === `mainnet`

### 3.3 Deflationary Model (NDT token)

- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** 2 % burn, 20 % staking, 30 % treasury (—É–∫–∞–∑–∞–Ω–æ –≤ `deflationary-model.ts`)
- **–í—ã–∑–æ–≤:** **–≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ `transferWithTax()`**, **–Ω–∏–∫–∞–∫–∏—Ö `transfer()` –Ω–∞–ø—Ä—è–º—É—é**
- **–¢–µ—Å—Ç:** `npm run test:solana` ‚Üí **–ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –Ω–∞ dev-net**

### 3.4 Solana / TON Security

- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
  - `instructions.length === 1`
  - `programId === PROGRAM_ID`
- **Seed-—Ñ—Ä–∞–∑—ã:** **–ù–ò–ö–û–ì–î–ê –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ env** ‚Üí **—Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º Keystore**
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** `src/lib/monitor-chain.ts` ‚Üí **–ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ > 1 SOL**

---

## 4. Mobile App (Expo)

### 4.1 –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

- **–ü–∞–ø–∫–∞:** `mobile-app/` ‚Üí **own package.json**, **own tsconfig**
- **–õ–∏–Ω—Ç–∏–Ω–≥:** `eslint-config-universe` (—Å—Ç—Ä–æ–≥–∏–π)
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** **Prettier mobile** (singleQuote: false ‚Äì —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å)

### 4.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π

- **API:** **–≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ `/api/mobile/**`\*\*
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** **JWT –æ—Ç–¥–µ–ª—å–Ω—ã–π**, **–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ 24 —á**
- **WebSocket:** **–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Ç–æ–º—É –∂–µ `server.ts`**, **–Ω–æ room = `mobile:{userId}`**

---

## 5. Code Review Checklist (REAL EDITION)

### 5.1 Web3 Security Check (CRITICAL - BLOCKER IF FAIL)

- [ ] **–ù–ï–¢ `window.solana` –∏–ª–∏ `window.phantom` –≤ –∫–æ–¥–µ** ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `getPhantomProvider()`
- [ ] **–ù–ï–¢ direct transaction, —Ç–æ–ª—å–∫–æ `transferWithTax()`** ‚Üí deflationary model enforcement
- [ ] **–ù–ï–¢ seed —Ñ—Ä–∞–∑ / private keys –≤ –∫–æ–¥–µ** ‚Üí —Ç–æ–ª—å–∫–æ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞
- [ ] ** –í–°–ï Web3 –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —á–µ—Ä–µ–∑ `PhantomUserRejectedError`, `BlockchainError`**
- [ ] ** –í–°–ï env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã –≤ `env.ts`**
- [ ] ** Program ID –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è `NORMALDANCE_PROGRAM_ID ===`**

### 5.2 Code Quality Check

- [ ] **–ù–ï–¢ `console.log` –≤ production –∫–æ–¥–µ** ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `logger.warn/error`
- [ ] ** –í–°–ï async –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç timeout –∏ error boundary**
- [ ] ** Mock –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ `__mocks__/` –ø–∞–ø–∫–µ**
- [ ] ** TypeScript: `any` —Ç–æ–ª—å–∫–æ –≤ `src/lib/legacy/` –∏–ª–∏ Web3 –º–æ–¥—É–ª—è—Ö**
- [ ] **Imports: React ‚Üí –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏**

### 5.3 Mobile App Isolation

- [ ] **Mobile –∫–æ–¥ –¢–û–õ–¨–ö–û –≤ `mobile-app/`**
- [ ] ** API endpoints –¥–ª—è mobile –≤ `/api/mobile/**`**
- [ ] ** –û—Ç–¥–µ–ª—å–Ω—ã–π JWT –¥–ª—è mobile (24h lifetime)**
- [ ] ** Socket.IO –∫–æ–º–Ω–∞—Ç—ã: `mobile:{userId}`**

### 5.4 Server Architecture Check

- [ ] ** Socket.IO –ø—É—Ç–∏ —Ç–æ–ª—å–∫–æ `/socketio/**`**
- [ ] ** CORS —Å—Ç—Ä–æ–≥–æ `NEXT_PUBLIC_SITE_URL`**
- [ ] ** Rate limiting –Ω–∞ ALL API routes**
- [ ] ** WebSocket –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–∑–≤–∞–Ω—ã (`user:`, `track:`, `mobile:`)**

### 5.5 Testing Requirements

- [ ] ** Web3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–º–æ–∫–∞–Ω—ã –≤ `src/lib/__mocks__/web3.ts`**
- [ ] ** Deflationary math –ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ unit —Ç–µ—Å—Ç–∞—Ö (2% validation)**
- [ ] ** Test timeout = 30s –¥–ª—è async Web3 –æ–ø–µ—Ä–∞—Ü–∏–π**
- [ ] ** Mock covers success + error scenarios**

### 5.6 Final Security Gate

- [ ] ** Telegram initData –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
- [ ] ** SQL injection protection (Prisma ORM)**
- [ ] ** XSS prevention (DOMPurify)**
- [ ] ** Large transaction monitoring (>1 SOL alerts)**
- [ ] ** All secrets in Vercel/production environment only**

---

## 6. PR Template (MANDATORY)

```markdown
## üéØ –¢–∏–ø —Ñ–æ—Ä–º—ã
- [ ] FEATURE: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [ ] BUGFIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞
- [ ] REFACTOR: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] SECURITY: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## ‚ö° Web3 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é `getPhantomProvider()` –≤–º–µ—Å—Ç–æ `window.solana`
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é `transferWithTax()` –≤–º–µ—Å—Ç–æ direct transfer
- [ ] –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `PhantomUserRejectedError`
- [ ] Program ID –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Web3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–º–æ–∫–∞–Ω—ã
- [ ] Deflationary math –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Timeout = 30s –¥–ª—è async
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ dev-net –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –ù–ï–¢ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
- [ ] Env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Rate limiting –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

## üì± Mobile (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- [ ] –ö–æ–¥ –≤ `mobile-app/`
- [ ] API —á–µ—Ä–µ–∑ `/api/mobile/**`
- [ ] –û—Ç–¥–µ–ª—å–Ω—ã–π JWT
```

---

## 6. –†–µ–∑—É–ª—å—Ç–∞—Ç

–î–æ–∫—É–º–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å **—Ç–æ—á–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞**, **—É—Å–∫–æ—Ä—è–µ—Ç –æ–Ω–±–æ—Ä–¥–∏–Ω–≥** –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ **—Å–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ¬´–∞ —É –º–µ–Ω—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª –≤ 3√ó**.

\*\*–û–±–Ω–æ–≤–ª—è—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫—Ä—É–ø–Ω–æ–≥–æ PR ‚Üí –≤–µ—Ä—Å–∏—è –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
