# Чек-лист модерации Telegram Mini App

## Обзор
Этот чек-лист предназначен для обеспечения успешного прохождения модерации вашего Telegram Mini App. Следование этим шагам может снизить риск отклонения до менее 5% и помочь достичь одобрения в течение 1-3 дней вместо 7-10.

## Технические требования перед отправкой

### 1. Метрики производительности
- [ ] **Оценка производительности Lighthouse**: ≥ 90
- [ ] **TTFB (Время до первого байта)**: < 200 мс (проверить с помощью `curl -w "@curl-format.txt" -s -o /dev/null https://your.app`)
- [ ] **Размер сборки**: Первый экран ≤ 170 КБ сжатый (без изображений)
- [ ] **Время загрузки**: Приложение загружается полностью в течение 3 секунд при соединении 4G

### 2. Заголовки безопасности (CSP)
- [ ] **Политика безопасности контента**: Нет `'unsafe-inline'` или `'unsafe-eval'` в script-src
- [ ] **Connect-src**: Только `self` и `https://api.telegram.org`
- [ ] **Внешние вызовы**: Все внешние запросы (например, RPC-ноды) проксируются через ваш бэкенд
- [ ] **Нет встроенных стилей**: Весь CSS находится в отдельных файлах .css (используйте `vite-plugin-css-injected-by-js` при необходимости)

### 3. Безопасность аутентификации
- [ ] **Окно аутентификации**: `auth_date` проверяется на сервере, чтобы быть ≤ 30 минут старше
- [ ] **Токен бота**: `TELEGRAM_BOT_TOKEN` хранится только на сервере, никогда в коде фронтенда
- [ ] **Проверка подписи**: Правильная проверка HMAC-SHA256 данных аутентификации Telegram
- [ ] **Нет хранения на клиенте**: Конфиденциальные токены не хранятся в localStorage/sessionStorage

### 4. Соответствие UI/UX
- [ ] **Нет системных диалогов**: Заменить все `alert()` и `confirm()` на пользовательские компоненты
- [ ] **Использование Main Button**: Только одна основная CTA на экране использует MainButton
- [ ] **Кнопка назад**: Правильно реализована с обработчиком `onEvent('backButtonClicked', ...)`
- [ ] **Проверка контраста**: Текст имеет надлежащий контраст с `themeParams.bg_color` (особенно черные фоны в темной теме)
- [ ] **Тактильная обратная связь**: Реализована для значимых пользовательских взаимодействий (плеер, покупка)

### 5. Требования к ресурсам
- [ ] **Логотип**: 512×512 прозрачный PNG формат
- [ ] **Иконка**: 100×100 прозрачный PNG без текста
- [ ] **Manifest.json**: Содержит правильные поля:
  ```json
  {
    "short_name": "normaldance",
    "scope": "./",
    "start_url": "./",
    "display": "standalone"
  }
  ```
- [ ] **Нет Service Worker**: Если не критично для автономной работы, избегайте `sw.js`, чтобы не вызывать вопросы модерации

### 6. Обработка ссылок
- [ ] **Внешние ссылки**: Все внешние ссылки открываются через `window.Telegram.WebApp.openLink()`
- [ ] **Нет прямой навигации**: Нет `window.open()` или прямой навигации по внешним URL
- [ ] **Глубокая ссылка**: Правильно реализована для внутренней навигации

### 7. Интеграция оплаты
- [ ] **Счет Stars**: Создается через API `/createInvoiceLink`
- [ ] **Полезная нагрузка счета**: Формат `nftId_userId_hash`
- [ ] **Подтверждение оплаты**: Ожидает `web_app_invoice_closed` со статусом `'paid'` перед минтингом NFT
- [ ] **Соответствие валюты**: 1 ⭐ ≈ 0.01 USD цена (округлено должным образом)

## Чек-лист тестирования

### 8. Тестирование на разных платформах
- [ ] **Тестирование iOS**: Приложение корректно работает в клиенте Telegram для iOS
- [ ] **Тестирование Android**: Приложение корректно работает в клиенте Telegram для Android
- [ ] **Тестирование настольного**: Приложение корректно работает в настольном клиенте Telegram
- [ ] **Тестирование темы**: Приложение выглядит хорошо в светлой и темной темах

### 9. Тестирование интеграции кошелька
- [ ] **TON Connect**: Подключение кошелька работает корректно
- [ ] **Поток транзакций**: Транзакции TON выполняются успешно
- [ ] **Тестирование резерва**: Альтернативные методы оплаты работают при сбое основного

### 10. Обработка ошибок
- [ ] **Резерв API**: Экран "Мини-приложение недоступно" с опцией контакта поддержки
- [ ] **Ошибки сети**: Корректная обработка сетевых проблем
- [ ] **Ошибки оплаты**: Правильные сообщения об ошибках для неудачных платежей
- [ ] **Ошибки аутентификации**: Четкая обратная связь для проблем с аутентификацией

## Конфигурация бота

### 11. Настройки BotFather
- [ ] **Встроенные местоположения**: Включены в BotFather
- [ ] **Кнопка меню**: "Команды" настроены с параметром web_app
- [ ] **Короткое имя**: Соответствует `short_name` в manifest.json
- [ ] **URL веб-приложения**: Правильно настроен с правильным доменом

### 12. Аналитика и мониторинг
- [ ] **Нет сторонней аналитики**: Google Analytics, Facebook Pixel удалены перед модерацией
- [ ] **События Bot API**: Используется метод `sendEvent` для аналитики
- [ ] **Мониторинг ошибок**: Sentry или аналогичная система настроена для отслеживания сбоев
- [ ] **Пользовательские данные**: Собираются только необходимые пользовательские данные в соответствии с рекомендациями Telegram

## Предварительная проверка запуска

### 13. Финальное тестирование
- [ ] **Тестирование в песочнице**: Приложение протестировано в среде песочницы Telegram
- [ ] **Тестирование на реальных устройствах**: Протестировано на реальных устройствах iOS и Android
- [ ] **Тестирование производительности**: Проверено при условиях нагрузки
- [ ] **Тестирование безопасности**: Проверка проникновения на распространенные уязвимости

### 14. Документация
- [ ] **Описание функций**: Четкое описание всех функций приложения
- [ ] **Внешние зависимости**: Список всех используемых внешних сервисов
- [ ] **Политика конфиденциальности**: Доступна и доступна
- [ ] **Условия использования**: Доступны и доступны

## Последующий мониторинг запуска

### 15. Мониторинг запуска
- [ ] **Порог ошибок**: Sentry настроен с порогом 50 ошибок/час для отката
- [ ] **Отслеживание конверсии**: Мониторинг коэффициента конверсии Кошелек → Покупка
- [ ] **Обратная связь пользователей**: Система для сбора первоначальных отзывов пользователей
- [ ] **Метрики производительности**: Непрерывный мониторинг времени загрузки и производительности

## Распространенные причины отклонения для избежания

- ❌ Использование системных диалогов `alert()` или `confirm()`
- ❌ CSP с `'unsafe-inline'` или `'unsafe-eval'`
- ❌ Сторонняя аналитика во время модерации
- ❌ Неправильная обработка `web_app_close`
- ❌ Отсутствие резервных экранов для сбоев API
- ❌ Неправильная конфигурация manifest.json
- ❌ Прямые внешние API-вызовы без проксирования
- ❌ Недействительная проверка auth_date (не проверка возраста данных аутентификации)

## Команды быстрой CLI-валидации

```bash
# Проверить размер сборки
ls -lh dist/index.html | awk '{print $5}'

# Проверить наличие небезопасного кода
grep -R "alert\|confirm" src/ && echo "clean" || echo "found system dialogs"

# Проверить дату аутентификации (Node.js)
node -e "console.log(Date.now()/1000 - 1800 < AUTH_DATE)"

# Проверить заголовки CSP
curl -I https://your.app | grep -i "Content-Security-Policy"

# Проверить форматы изображений
file icon512.png  # Должно показать PNG с альфа-каналом
```

## Финальные шаги проверки

Перед отправкой на модерацию Telegram:

1. [ ] Пройти все пользовательские потоки вручную
2. [ ] Убедиться, что все чек-листы выше выполнены
3. [ ] Протестировать на нескольких устройствах и платформах
4. [ ] Убедиться, что все состояния ошибок обрабатываются корректно
5. [ ] Подтвердить, что все внешние сервисы правильно проксированы
6. [ ] Убедиться, что конфиденциальные данные не хранятся на клиенте
7. [ ] Тщательно протестировать потоки оплаты
8. [ ] Подтвердить, что метрики производительности соответствуют требованиям
9. [ ] Убедиться, что все элементы UI работают в обеих темах
10. [ ] Протестировать весь поток аутентификации и оплаты от начала до конца

## План аварийного отката

- [ ] Система контроля версий с возможностью быстрого отката
- [ ] Система мониторинга для обнаружения проблем в течение 1 часа после развертывания
- [ ] Документированные и протестированные процедуры отката
- [ ] План коммуникации для пользователей в случае отката