# Настройка SSL сертификата через Let's Encrypt для normaldance.ru

Этот скрипт автоматизирует процесс установки и настройки SSL сертификата через Let's Encrypt для домена normaldance.ru.

## Особенности скрипта

- ✅ Автоматическая установка Certbot и плагина для Nginx
- ✅ Получение SSL сертификата для основного домена и www-поддомена
- ✅ Автоматическое продление сертификатов через systemd таймер
- ✅ Полная настройка Nginx для работы с HTTPS
- ✅ Перенаправление HTTP на HTTPS
- ✅ Настройка HSTS заголовков для безопасности
- ✅ Поддержка IPv6
- ✅ Резервное копирование конфигурации Nginx перед изменениями
- ✅ Мониторинг срока действия сертификата
- ✅ Обработка ошибок и проверка валидности
- ✅ Подробные логи на русском языке

## Требования

- Операционная система: Ubuntu/Debian
- Доступ к серверу с правами root (sudo)
- Доменное имя normaldance.ru должно указывать на IP адрес сервера
- Должен быть установлен и настроен Nginx

## Установка

1. Скачайте скрипт на сервер:

```bash
wget https://raw.githubusercontent.com/your-repo/scripts/setup-ssl-ruvds.sh
```

2. Сделайте скрипт исполняемым:

```bash
chmod +x setup-ssl-ruvds.sh
```

3. Запустите скрипт от имени root:

```bash
sudo ./setup-ssl-ruvds.sh
```

## Использование

### Основная установка

```bash
sudo ./setup-ssl-ruvds.sh
```

Эта команда выполнит полную настройку SSL сертификата:

- Установит Certbot
- Получит SSL сертификат
- Настроит Nginx для HTTPS
- Настроит автоматическое продление
- Настроит мониторинг

### Проверка статуса

```bash
sudo ./setup-ssl-ruvds.sh --check
```

Проверяет текущий статус SSL сертификата и его срок действия.

### Продление сертификата

```bash
sudo ./setup-ssl-ruvds.sh --renew
```

Принудительно продляет SSL сертификат.

### Мониторинг срока действия

```bash
sudo ./setup-ssl-ruvds.sh --monitor
```

Проверяет срок действия сертификата и выводит информацию.

### Справка

```bash
sudo ./setup-ssl-ruvds.sh --help
```

## Конфигурация

### Переменные в скрипте

Вы можете изменить основные переменные в начале скрипта:

```bash
DOMAIN="normaldance.ru"
WWW_DOMAIN="www.normaldance.ru"
EMAIL="admin@normaldance.ru"
NGINX_CONFIG_DIR="/etc/nginx"
```

### Настройка Nginx

Скрипт создает конфигурацию Nginx в `/etc/nginx/sites-available/normaldance.ru` со следующими параметрами:

- Слушает порты 80 и 443
- Поддерживает IPv6
- Автоматическое перенаправление HTTP → HTTPS
- HSTS заголовки
- Оптимальные настройки SSL

## Автоматическое продление

Скрипт настраивает systemd таймер для ежедневной проверки и автоматического продления сертификатов:

- Таймер: `/etc/systemd/system/certbot-renew.timer`
- Сервис: `/etc/systemd/system/certbot-renew.service`

Проверить статус таймера:

```bash
systemctl status certbot-renew.timer
```

## Мониторинг

### Скрипт мониторинга

Скрипт создает `/usr/local/bin/check-ssl-expiry.sh` для проверки срока действия сертификата.

### Cron задание

Добавляет ежедневную проверку в cron:

```bash
0 9 * * * /usr/local/bin/check-ssl-expiry.sh
```

### Ручная проверка

```bash
/usr/local/bin/check-ssl-expiry.sh
```

## Логирование

Скрипт создает логи в следующих директориях:

- `/var/log/ssl/` - логи SSL операций
- `/var/log/nginx/` - логи Nginx
- `/root/nginx-backups/` - резервные копии конфигурации

## Восстановление

### Если что-то пошло не так

1. Восстановите конфигурацию Nginx из резервной копии:

```bash
cd /root/nginx-backups
tar -xzf nginx_config_backup_*.tar.gz -C /
```

2. Перезапустите Nginx:

```bash
systemctl restart nginx
```

### Проверка конфигурации Nginx

```bash
nginx -t
```

## Проверка работы

### Проверка HTTPS

```bash
curl -I https://normaldance.ru
```

### Проверка перенаправления

```bash
curl -I http://normaldance.ru
```

### Проверка SSL сертификата

```bash
openssl s_client -connect normaldance.ru:443 -servername normaldance.ru
```

### Проверка HSTS

```bash
curl -s -I https://normaldance.ru | grep -i strict-transport-security
```

## Частые проблемы

### 1. Домен не доступен

Убедитесь, что DNS запись домена указывает на IP адрес сервера.

### 2. Порты 80/443 заняты

Проверьте, какие сервисы используют порты:

```bash
netstat -tlnp | grep -E '80|443'
```

### 3. Сертификат не продлевается

Проверьте логи таймера:

```bash
journalctl -u certbot-renew.timer
```

### 4. Nginx не запускается

Проверьте конфигурацию:

```bash
nginx -t
systemctl status nginx
journalctl -u nginx
```

## Безопасность

### HSTS заголовки

Скрипт настраивает следующие HSTS заголовки:

- `max-age=63072000` - 2 года
- `includeSubDomains` - включает поддомены
- `preload` - для HSTS preload списка

### SSL настройки

Используются современные настройки SSL:

- TLS 1.2 и 1.3
- Современные шифры
- Отключение SSL сессий

## Резервное копирование

Скрипт автоматически создает резервные копии конфигурации Nginx в `/root/nginx-backups/` перед внесением изменений.

### Создание ручной резервной копии

```bash
tar -czf /root/nginx-backups/manual_backup_$(date +%Y%m%d_%H%M%S).tar.gz /etc/nginx
```

## Обновление

Для обновления скрипта:

1. Скачайте новую версию
2. Сделайте резервную копию текущей конфигурации
3. Запустите новый скрипт

## Поддержка

Если у вас возникли проблемы:

1. Проверьте логи скрипта
2. Убедитесь, что все требования выполнены
3. Проверьте DNS настройки
4. Убедитесь, что Nginx работает
5. Проверьте доступность домена

## Лицензия

Скрипт предоставляется как есть без каких-либо гарантий.

## Версия

Версия: 1.0
Дата: 2025-09-21
Автор: Roo AI Assistant
